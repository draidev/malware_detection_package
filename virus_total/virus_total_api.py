import requests
import json
from itertools import chain
from collections import defaultdict
from time import localtime, strftime

def VT_get_a_file_report(file_hash):
    url = "https://www.virustotal.com/api/v3/files/" + "/" + file_hash
    API = "your-api"
    
    headers = {
        "accept": "application/json",
        "x-apikey": API
    }

    response = requests.get(url, headers=headers)

    return response.text


def VT_get_report_list_with_hash(hash_list):
    report_list = []
    for h in hash_list:
        report = VT_get_a_file_report(h)
        report_list.append(report)
    
    return report_list


# get only data report except error report
def VT_convert_report_to_json_list(report_list):
    err_cnt = 0
    data_cnt = 0

    data_list = []
    for i, rep in enumerate(report_list):
        if 'error' in list(json.loads(rep).keys()):
            err_cnt += 1

        elif 'data' in list(json.loads(rep).keys()):
            data_cnt += 1
            data_list.append(json.loads(rep))

        else:
            print("index \"{}\" extra case!!", i)
            print(json.loads(rep))
    
    print("error count : {}\ndata count: {}".format(err_cnt, data_cnt))
    
    return data_list


"""
    function VT_get_stats_count "key" parameter can get bottom keywords
    'malicious', 'suspicious', 'undetected', 'harmless', 'timeout', 'confirmed-timeout', 'failure', 'type-unsupported'
"""
def VT_get_stats_count(response_json, category:str):
    last_analysis_stats = response_json['data']['attributes']['last_analysis_stats']
    count = last_analysis_stats[category]
    return count


def VT_vendor_analysis(response_json, category) -> dict:
    vendors_list = list(response_json['data']['attributes']['last_analysis_results'].keys())
    
    vendor_category_list = list()
    cat_vendor_list = list() 
    vendors_dict = dict()
    for vendor in vendors_list:
        vendor_category = response_json['data']['attributes']['last_analysis_results'][vendor]['category']
        if vendor_category == category:
            cat_vendor_list.append(vendor)
    
    vendors_dict[category+'_vendors'] = cat_vendor_list
    vendors_dict[category+'_count'] = VT_get_stats_count(response_json, category)
    
    return vendors_dict


# from itertools import chain
# from collections import defaultdict
# from time import localtime, strftime
def VT_make_analysis_df(data_list:list, category_list:list):
    df_dict = dict()
    for data in data_list:
        id_ = data['data']['id']
        
        cat_vendor_dict_list = list()
        for category in category_list:
            cat_vendor_dict_list.append(VT_vendor_analysis(data, category).items())
                
        default_dict = defaultdict(list)
        default_dict['names'] = data['data']['attributes']['names']
        default_dict['creation_date'] = VT_get_creation_date(data)
        default_dict['md5'] = data['data']['attributes']['md5']
        for k, v  in chain(*cat_vendor_dict_list):
            if v == []:
                default_dict[k]
            else:
                default_dict[k] = v
        
        df_dict[id_] = default_dict
    
    df = pd.DataFrame.from_dict(df_dict, orient='index')
    return df

def VT_get_creation_date(json_data):
    try:
        creation_date = json_data['data']['attributes']['creation_date']
        tm = localtime(creation_date)
        return strftime("%Y-%m-%d", tm)
    except:
        return None
